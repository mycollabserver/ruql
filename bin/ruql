#!/usr/bin/env ruby

# require 'ruql'
require_relative '../lib/ruql'
require 'getopt/long'

def usage
  name = File.basename $0
  STDERR.puts <<eos
Usage: #{name} filename.rb renderer [options]
filename.rb contains questions expressed in RuQL

renderer choices are:
  Html5    - HTML 5 suitable for Web display/printing
  HtmlForm - HTML forms
  EdXml    - XML for OpenEdX platform in-course questions
  AutoQCM  - LaTeX for use with AutoQCM (http://home.gna.org/auto-qcm)
  Coursera - [obsolete] Coursera HTML/XML format for online auto-grading
  JSON     - [partially implemented] JSON format
  Qualtrics -[partially implemented] Qualtrics survey (txt) format

Global options:
  -l <loglevel>, --log=<loglevel>
     In increasing verbosity, they are 'error' (nonfatal), 'warn', 'info',
     'debug'; default is 'warn'
  -p <penalty>, --penalty <penalty>
     The penalty for WRONG answers, as a fraction of the penalty for
     RIGHT answers.  For a 2-point question, penalty=0.25 means 1/2 point
     (0.25 * 2) deducted for WRONG answer.  Default is 0.  Not all
     output formats are able to do something useful with this.

The EdXML renderer supports these options:
  -n <name>, --name=<name>
      Only render the question(s) that have :name => 'name'.
  NOTE: Some markup that is legal in RuQL questions will break the EdX parser.
     Manually check your questions as you enter them into EdX.  Code seems to
     be particularly troublesome.
  NOTE: The 'points' and 'randomize' attributes of questions are not honored by
     some systems.

  -y <file.yml>, --yaml=<file.yml>
      Render the questions with a specific yaml file.

The AutoQCM renderer supports these options:
  -t <file.tex.erb>, --template=<file.tex.erb>
      MANDATORY: Use file.tex.erb as LaTeX/AutoQCM template.
      The file should have <%= yield %> where questions should go.
      See the description of template under HTML5 renderer for variable
      substitutions that can occur in the quiz body.

The JSON renderer currently supports no options

The Qualtrics renderer supports these options:
  -t <file.txt.erb>, --template=<file.txt.erb>
  The file should have <%= yield %> where questions should go. Since this just creates survey questions, grading information is ignored.Currently supports the same type of questions as the AutoQCM renderer.

eos
  exit false
end

def main
  if ARGV[0] =~ /--?v/
    puts Ruql::VERSION
    exit(true)
  end
  filename = ARGV.shift
  raise "Cannot read #{filename}" unless File.readable? filename
  renderer = ARGV.shift
  raise "Unknown renderer '#{renderer}'" unless (renderer = Quiz.get_renderer(renderer))

  help,options = renderer.allowed_options

  options += [
    ['-H', '--help', Getopt::BOOLEAN]
  ]
  opts = Getopt::Long.getopts(options)
    # ['-j', '--js', Getopt::REQUIRED],
    # ['-n', '--name', Getopt::REQUIRED],
    # ['-l', '--log', Getopt::REQUIRED],
    # ['-y', '--yaml', Getopt::REQUIRED]

  usage if opts.delete('H') || opts.delete('--help')
  Quiz.set_yaml_file opts.delete("y") || opts.delete("yaml")
  Quiz.instance_eval "#{IO.read(filename)}"
  Quiz.quizzes.each { |quiz| puts quiz.render_with(renderer, opts)  }
end

usage if ARGV.length < 1
main

